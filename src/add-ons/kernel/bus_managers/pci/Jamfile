SubDir OBOS_TOP src add-ons kernel bus_managers pci ;

UsePrivateHeaders [ FDirName kernel ] ;
UsePrivateHeaders [ FDirName kernel util ] ;

KernelMergeObject pci_bus_manager.o : 
	kernel_cpp.cpp
	<$(SOURCE_GRIST)>pci.cpp
	<$(SOURCE_GRIST)>pci_info.cpp
	<$(SOURCE_GRIST)>pci_module.c
	:
	-fno-pic -Wno-unused -D_KERNEL_MODE
	;

SEARCH on [ FGristFiles
		kernel_cpp.cpp 
	] = [ FDirName $(OBOS_TOP) src kernel core util ] ;

KernelLd pci :
	pci_bus_manager.o
	pci_arch_$(OBOS_ARCH)_bus_manager.o
	kernel.so
	:
	$(OBOS_TOP)/src/kernel/ldscripts/$(OBOS_ARCH)/add-on.ld
	:
	-Bdynamic -shared
	;

# pci_info.cpp currently needs pcihdr.h so we make its path available
ObjectHdrs [ FGristFiles pci_info$(SUFOBJ) ]
	: [ FDirName $(OBOS_TOP) src prefs devices ] ;

SubInclude OBOS_TOP src add-ons kernel bus_managers pci arch $(OBOS_ARCH) ;
