SubDir HAIKU_TOP src tests servers app ;

SetSubDirSupportedPlatforms r5 bone ;

UseHeaders [ FStandardOSHeaders ] : true ;
UseHeaders [ FDirName $(HAIKU_TOP) headers posix ] : true ;
	# TODO: POSIX headers shouldn't be used. Needed for strlcpy() and addr_t.

# Remove _NO_INLINE_ASM from the defines for syslog.cpp. Otherwise we get
# references to tls_get/set() etc. that don't exist under BeOS.
#TARGET_DEFINES on [ FGristFiles syslog.o ]
#	= [ FFilter $(TARGET_DEFINES) : _NO_INLINE_ASM ] ;

UseLibraryHeaders agg png zlib ;
UsePrivateHeaders app interface shared [ FDirName servers app ] ;

local appServerDir = [ FDirName $(HAIKU_TOP) src servers app ] ;

UseHeaders [ FDirName $(appServerDir) drawing ] ;
UseHeaders [ FDirName $(appServerDir) drawing Painter ] ;
UseHeaders [ FDirName $(appServerDir) drawing Painter drawing_modes ] ;
UseHeaders [ FDirName $(appServerDir) drawing Painter font_support ] ;
UseFreeTypeHeaders ;

SEARCH_SOURCE += $(appServerDir) [ FDirName $(appServerDir) drawing ] ;

# No need to define any of those targets, when building for haiku
if $(TARGET_PLATFORM) != haiku {

SharedLibrary libhwinterface.so :
	BBitmapBuffer.cpp
	HWInterface.cpp
	MultiLocker.cpp

	: libhaikuappserver.so libopenbeos.so
;


# The reason for this is that libhwinterfaceimpl.so needs to link against
# libbe *first*, but simply adding it to the library list would add it to
# LINKLIBS which is always appended after NEEDLIBS in the command line.
LINKFLAGS on libhwinterfaceimpl.so ?= $(LINKFLAGS) ;
LINKFLAGS on libhwinterfaceimpl.so += -lbe ;

SharedLibrary libhwinterfaceimpl.so :
	fake_input_server.cpp
	ViewHWInterface.cpp

	: libopenbeos.so libhwinterface.so
;

SharedLibrary libhaikuappserver.so :
	Angle.cpp
	BGet++.cpp
	BitmapManager.cpp
	ColorSet.cpp
	CursorData.cpp
	CursorSet.cpp
	Decorator.cpp
	DesktopSettings.cpp
	DrawState.cpp
	FontFamily.cpp
	IPoint.cpp
	RGBColor.cpp
	ServerBitmap.cpp
	ServerCursor.cpp
	ServerFont.cpp
	FontManager.cpp
	SystemPalette.cpp
	TokenHandler.cpp
	Utils.cpp

	# drawing
	PatternHandler.cpp
	DisplayDriver.cpp

	# libraries
	:
	libopenbeos.so libtextencoding.so libfreetype.so
;

AddResources haiku_app_server : app_server.rdef ;

Server haiku_app_server :
	# Misc. Sources
	DebugInfoManager.cpp
	SubWindowList.cpp
	#PicturePlayer.cpp
	PNGDump.cpp
	RAMLinkMsgReader.cpp
	MessageLooper.cpp

	# Manager Classes
	CursorManager.cpp
	DecorManager.cpp
	ScreenManager.cpp

	AppServer.cpp
	Desktop.cpp

	ServerApp.cpp
	ServerWindow.cpp

	# DisplayDriver Classes
	AccelerantBuffer.cpp
	AccelerantHWInterface.cpp
	BitmapBuffer.cpp
	DisplayDriverPainter.cpp
	MallocBuffer.cpp
	UpdateQueue.cpp

	VirtualScreen.cpp
	BitmapHWInterface.cpp
	DefaultDecorator.cpp
	Layer.cpp
	OffscreenServerWindow.cpp
	OffscreenWinBorder.cpp
	RootLayer.cpp
	ServerPicture.cpp
	ServerScreen.cpp
	WinBorder.cpp
	Workspace.cpp
	WorkspacesLayer.cpp

	# libraries
	:
	z libpng.so libhaikuappserver.so
	libpainter.a libopenbeos.so 
	libhwinterface.so libhwinterfaceimpl.so
	libagg.a libfreetype.so libtextencoding.so
;

# install in the test dir
HaikuInstall install-test-apps : $(HAIKU_APP_TEST_LIB_DIR)
	: libpng.so libhaikuappserver.so libopenbeos.so libhwinterface.so
	  libhwinterfaceimpl.so libfreetype.so libtextencoding.so
	: tests!apps ;

HaikuInstall install-test-apps : $(HAIKU_APP_TEST_DIR) : haiku_app_server
	: tests!apps ;

} # if $(TARGET_PLATFORM) != haiku

SubInclude HAIKU_TOP src tests servers app bitmap_drawing ;
SubInclude HAIKU_TOP src tests servers app copy_bits ;
SubInclude HAIKU_TOP src tests servers app painter ;
SubInclude HAIKU_TOP src tests servers app playground ;
SubInclude HAIKU_TOP src tests servers app resize_limits ;
SubInclude HAIKU_TOP src tests servers app scrolling ;
SubInclude HAIKU_TOP src tests servers app textview ;
SubInclude HAIKU_TOP src tests servers app regularapps ;
SubInclude HAIKU_TOP src tests servers app view_state ;
