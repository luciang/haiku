SubDir HAIKU_TOP src system ;

KernelLd boot_loader :
	boot_platform_$(TARGET_BOOT_PLATFORM).o
	boot_loader.a
	boot_partitions.a

	# file systems
	boot_bfs.a
	boot_amiga_ffs.a
	boot_tarfs.a

	libz.a

	# libroot functions needed by the stage2 boot loader
	<$(SOURCE_GRIST)!libroot!os!arch!$(TARGET_ARCH)>byteorder.o
	<$(SOURCE_GRIST)!libroot>ctype.o
	<$(SOURCE_GRIST)!libroot>kernel_vsprintf.o
	<$(SOURCE_GRIST)!libroot!posix!string>memset.o
	<$(SOURCE_GRIST)!libroot!posix!string>memcmp.o
	<$(SOURCE_GRIST)!libroot!posix!string>memcpy.o
	<$(SOURCE_GRIST)!libroot!posix!string>memmove.o
	<$(SOURCE_GRIST)!libroot!posix!string>strdup.o
	<$(SOURCE_GRIST)!libroot!posix!string>strlen.o
	<$(SOURCE_GRIST)!libroot!posix!string>strnlen.o
	<$(SOURCE_GRIST)!libroot!posix!string>strcmp.o
	<$(SOURCE_GRIST)!libroot!posix!string>strcasecmp.o
	<$(SOURCE_GRIST)!libroot!posix!string>strncmp.o
	<$(SOURCE_GRIST)!libroot!posix!string>strcat.o
	<$(SOURCE_GRIST)!libroot!posix!string>strcpy.o
	<$(SOURCE_GRIST)!libroot!posix!string>strlcat.o
	<$(SOURCE_GRIST)!libroot!posix!string>strlcpy.o
	<$(SOURCE_GRIST)!libroot!posix!string>strchr.o
	<$(SOURCE_GRIST)!libroot!posix!string>strrchr.o
	<$(SOURCE_GRIST)!libroot!posix!stdlib>strtol.o
	<$(SOURCE_GRIST)!libroot>qsort.o
	<$(SOURCE_GRIST)!kernel!arch!$(TARGET_ARCH)>cpuid.o
	: $(SUBDIR)/ldscripts/$(TARGET_ARCH)/boot_loader.ld 
	: -Bstatic
	;

rule BuildZbeos {
	local zbeos = $(1) ;
	local bootLoader = $(2) ;

	Depends $(zbeos) : $(bootLoader) ;
	MakeLocateDebug $(zbeos) ;
}

actions BuildZbeos {
	rm -f $(1)
	$(TARGET_OBJCOPY) -O binary $(2) $(1)
}

BuildZbeos zbeos : boot_loader ;

KernelLd stage2 :
	boot_arch_stage2.o

	# posix functions needed by the stage2 boot loader
	<$(SOURCE_GRIST)!libroot>ctype.o
	<$(SOURCE_GRIST)!libroot>kernel_vsprintf.o
	<$(SOURCE_GRIST)!libroot!posix!string>memset.o
	<$(SOURCE_GRIST)!libroot!posix!string>memcpy.o
	<$(SOURCE_GRIST)!libroot!posix!string>strnlen.o
	: $(SUBDIR)/ldscripts/$(TARGET_ARCH)/stage2.ld 
	: -dN
	:
	;

KernelLd kernel_$(TARGET_ARCH) :
	kernel_core.o
	kernel_fs.o
	kernel_vm.o
	kernel_cache.o
	kernel_device_manager.o
	kernel_disk_device_manager.o
	kernel_util.o
	kernel_messaging.o
	kernel_debug.o

	lib$(TARGET_ARCH).a

	linkhack.so

	# kernel libroot parts
	kernel_os_main.o
	kernel_os_arch_$(TARGET_ARCH).o
	kernel_posix.o

	: $(SUBDIR)/ldscripts/$(TARGET_ARCH)/kernel.ld 
	: -Bdynamic -export-dynamic -dynamic-linker /foo/bar
	:
	;

KernelLd kernel.so :
	kernel_core.o
	kernel_fs.o
	kernel_vm.o
	kernel_cache.o
	kernel_device_manager.o
	kernel_disk_device_manager.o
	kernel_util.o
	kernel_messaging.o
	kernel_debug.o

	lib$(TARGET_ARCH).a

	linkhack.so

	# kernel libroot parts
	kernel_os_main.o
	kernel_os_arch_$(TARGET_ARCH).o
	kernel_posix.o

	: $(SUBDIR)/ldscripts/$(TARGET_ARCH)/kernel.ld 
	: -Bdynamic -shared -export-dynamic -dynamic-linker /foo/bar
	;

UnarchiveObjects $(TARGET_GCC_LIBGCC_OBJECTS) : $(TARGET_GCC_LIBGCC) ;
	# we need to link against libgcc.a objects and make
	# it available to other applications as in BeOS

local librootObjects = 
	os_main.o
	os_arch_$(TARGET_ARCH).o

	posix_arch_$(TARGET_ARCH).o
	posix_crypt.o
	posix_locale.o
	posix_main.o
	posix_malloc.o
	posix_math.o
	posix_math_arch_$(TARGET_ARCH).o
	posix_pthread.o
	posix_signal.o
	posix_stdio.o
	posix_gnu_arch_$(TARGET_ARCH).o
	posix_gnu_ctype.o
	posix_gnu_ext.o
	posix_gnu_libio.o
	posix_gnu_locale.o
	posix_gnu_regex.o
	posix_gnu_stdio.o
	posix_gnu_stdlib.o
	posix_gnu_wcsmbs.o
	posix_stdlib.o
	posix_string.o
	posix_sys.o
	posix_time.o
	posix_unistd.o
;

SharedLibraryFromObjects libroot.so : :
	$(TARGET_GCC_LIBGCC_OBJECTS)
	<$(SOURCE_GRIST)!libroot>libroot_init.o

	$(librootObjects:G=nogrist)
;

NotFile kernel ;
Depends kernel : kernel_$(TARGET_ARCH) ;
Depends kernel.so : kernel ;
	# kernel.so will be rebuilt with the kernel

SubInclude HAIKU_TOP src system boot ;
SubInclude HAIKU_TOP src system kernel ;
SubInclude HAIKU_TOP src system glue ;
SubInclude HAIKU_TOP src system libroot ;
SubInclude HAIKU_TOP src system runtime_loader ;
